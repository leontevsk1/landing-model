import numpy as np
import math
from classes import Drone, Environment, Beacon
# –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –≤—ã –¥–æ–±–∞–≤–∏–ª–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –∫–∏–Ω–µ–º–∞—Ç–∏–∫–∏ –≤ classes.py, 
# –≤–∫–ª—é—á–∞—è _update_kinematics(dt), change_altitude_rate, change_speed, change_yaw

# --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ ---
def vec_to_deg(v):
    """–ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –≤–µ–∫—Ç–æ—Ä [x, y] –≤ —É–≥–æ–ª —Ä—ã—Å–∫–∞–Ω—å—è (yaw) –≤ –≥—Ä–∞–¥—É—Å–∞—Ö."""
    # –£–≥–æ–ª yaw –æ—Ç—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –æ—Ç –æ—Å–∏ +X (0 –≥—Ä–∞–¥—É—Å–æ–≤)
    yaw_rad = math.atan2(v[1], v[0])
    return math.degrees(yaw_rad)

def vec_to_pitch_deg(v):
    """–ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç 3D –≤–µ–∫—Ç–æ—Ä v –≤ —É–≥–æ–ª —Ç–∞–Ω–≥–∞–∂–∞ (pitch) –≤ –≥—Ä–∞–¥—É—Å–∞—Ö."""
    # pitch - —É–≥–æ–ª –º–µ–∂–¥—É –≤–µ–∫—Ç–æ—Ä–æ–º –∏ –ø–ª–æ—Å–∫–æ—Å—Ç—å—é XY
    horizontal_mag = np.linalg.norm(v[:2])
    pitch_rad = math.atan2(v[2], horizontal_mag)
    return math.degrees(pitch_rad)

# --- –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –¢–ï–°–¢–ê ---
def test_drone_kinematics():
    """–¢–µ—Å—Ç –±–∞–∑–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –¥–≤–∏–∂–µ–Ω–∏—è –¥—Ä–æ–Ω–∞."""
    print("--- üî¨ –¢–µ—Å—Ç –ö–∏–Ω–µ–º–∞—Ç–∏–∫–∏ –î—Ä–æ–Ω–∞ ---")
    
    # 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    dt = 1.0  # –®–∞–≥ –≤—Ä–µ–º–µ–Ω–∏ (1 —Å–µ–∫—É–Ω–¥–∞)
    
    # –î—Ä–æ–Ω —Å—Ç–∞—Ä—Ç—É–µ—Ç –≤ —Ç–æ—á–∫–µ (0, 0, 100), —Å–∫–æ—Ä–æ—Å—Ç—å 10 –º/—Å, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ +X (1, 0, 0)
    drone = Drone(x=0.0, y=0.0, z=100.0)
    drone.speed = 10.0
    drone.direction = np.array([1.0, 0.0, 0.0], float) # –ï–¥–∏–Ω–∏—á–Ω—ã–π –≤–µ–∫—Ç–æ—Ä, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –ø–æ –æ—Å–∏ X
    
    # –ü–µ—á–∞—Ç—å –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    print(f"–°—Ç–∞—Ä—Ç: –ü–æ–∑–∏—Ü–∏—è: {drone.pos}, –°–∫–æ—Ä–æ—Å—Ç—å: {drone.speed:.1f} –º/—Å, –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: {drone.direction}")
    
    # 2. –¢–µ—Å—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏ (change_speed)
    drone.change_speed(5.0) # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å –Ω–∞ 5 –º/—Å
    print(f"\n–¢–µ—Å—Ç 1 (–°–∫–æ—Ä–æ—Å—Ç—å): –°–∫–æ—Ä–æ—Å—Ç—å –ø–æ—Å–ª–µ +5 –º/—Å: {drone.speed:.1f} –º/—Å")
    
    drone._update_kinematics(dt) # –®–∞–≥ –¥–≤–∏–∂–µ–Ω–∏—è
    print(f"–ü–æ–∑–∏—Ü–∏—è –ø–æ—Å–ª–µ 1—Å –¥–≤–∏–∂–µ–Ω–∏—è: {drone.pos}")
    
    # –û–∂–∏–¥–∞–µ–º–∞—è –ø–æ–∑–∏—Ü–∏—è: (0 + 15*1*1, 0, 100) = (15, 0, 100)
    assert np.allclose(drone.pos, np.array([15.0, 0.0, 100.0])), "–û—à–∏–±–∫–∞ –≤ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–∫–æ—Ä–æ—Å—Ç–∏/–∫–∏–Ω–µ–º–∞—Ç–∏–∫–µ"

    # 3. –¢–µ—Å—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫—É—Ä—Å–∞ (change_yaw)
    yaw_change = math.pi / 2 # –ü–æ–≤–æ—Ä–æ—Ç –Ω–∞ +90 –≥—Ä–∞–¥—É—Å–æ–≤ (–ø—Ä–æ—Ç–∏–≤ —á–∞—Å–æ–≤–æ–π —Å—Ç—Ä–µ–ª–∫–∏)
    drone.change_yaw(yaw_change)
    
    yaw_deg = vec_to_deg(drone.direction)
    print(f"\n–¢–µ—Å—Ç 2 (–ö—É—Ä—Å): –ö—É—Ä—Å –ø–æ—Å–ª–µ +90¬∞: {yaw_deg:.1f}¬∞")
    
    # –û–∂–∏–¥–∞–µ–º–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: (0, 1, 0) - –ø–æ –æ—Å–∏ Y
    assert np.allclose(drone.direction, np.array([0.0, 1.0, 0.0], float), atol=1e-6), "–û—à–∏–±–∫–∞ –≤ –ø–æ–≤–æ—Ä–æ—Ç–µ –∫—É—Ä—Å–∞ (Yaw)"
    
    drone._update_kinematics(dt) # –®–∞–≥ –¥–≤–∏–∂–µ–Ω–∏—è
    print(f"–ü–æ–∑–∏—Ü–∏—è –ø–æ—Å–ª–µ 1—Å –¥–≤–∏–∂–µ–Ω–∏—è: {drone.pos}")
    
    # –û–∂–∏–¥–∞–µ–º–∞—è –ø–æ–∑–∏—Ü–∏—è: (15, 0 + 15*1*1, 100) = (15, 15, 100)
    assert np.allclose(drone.pos, np.array([15.0, 15.0, 100.0])), "–û—à–∏–±–∫–∞ –≤ –∫–∏–Ω–µ–º–∞—Ç–∏–∫–µ –ø–æ—Å–ª–µ –ø–æ–≤–æ—Ä–æ—Ç–∞"

    # 4. –¢–µ—Å—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–∞–Ω–≥–∞–∂–∞/—Å–Ω–∏–∂–µ–Ω–∏—è (change_altitude_rate)
    pitch_down = -math.radians(45) # –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞ 45 –≥—Ä–∞–¥—É—Å–æ–≤
    drone.change_altitude_rate(pitch_down)
    
    pitch_deg = vec_to_pitch_deg(drone.direction)
    print(f"\n–¢–µ—Å—Ç 3 (–¢–∞–Ω–≥–∞–∂): –¢–∞–Ω–≥–∞–∂ –ø–æ—Å–ª–µ -45¬∞: {pitch_deg:.1f}¬∞")

    # –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –≤–µ–∫—Ç–æ—Ä –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç–∞–ª –Ω–∞–∫–ª–æ–Ω–µ–Ω–Ω—ã–º
    # –û–∂–∏–¥–∞–µ–º—ã–π –≤–µ–∫—Ç–æ—Ä: (~0.707 –ø–æ XY, -0.707 –ø–æ Z). XY –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏ –ø—Ä–æ–ø–æ—Ä—Ü–∏—é 0:1.
    expected_dir = np.array([0.0, math.cos(45 * math.pi / 180), -math.sin(45 * math.pi / 180)])
    assert np.allclose(drone.direction, expected_dir, atol=1e-6), "–û—à–∏–±–∫–∞ –≤ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–∞–Ω–≥–∞–∂–∞ (Pitch)"

    drone._update_kinematics(dt) # –®–∞–≥ –¥–≤–∏–∂–µ–Ω–∏—è
    print(f"–ü–æ–∑–∏—Ü–∏—è –ø–æ—Å–ª–µ 1—Å –¥–≤–∏–∂–µ–Ω–∏—è: {drone.pos}")
    
    # –û–∂–∏–¥–∞–µ–º–æ–µ —Å–Ω–∏–∂–µ–Ω–∏–µ: Z_new = 100 + 15 * (-0.707) * 1 ‚âà 100 - 10.605 = 89.395
    expected_z = 100.0 + drone.speed * drone.direction[2] * dt
    print(f"–û–∂–∏–¥–∞–µ–º–∞—è Z: {expected_z:.3f}")
    assert np.allclose(drone.pos[2], expected_z), "–û—à–∏–±–∫–∞ –≤ Z-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–µ –ø–æ—Å–ª–µ —Å–Ω–∏–∂–µ–Ω–∏—è"
    
    print("\n‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –∫–∏–Ω–µ–º–∞—Ç–∏–∫–∏ –¥—Ä–æ–Ω–∞ –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!")

if __name__ == '__main__':
    test_drone_kinematics()